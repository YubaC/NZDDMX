<!DOCTYPE html>
<html lang="zh_cn">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文字游戏</title>
</head>

<body>
    <style>
        #save {
            padding: 10px;
            margin: 10px;
        }
        
        li {
            margin: 5px;
        }
        
        .up,
        .down,
        .left,
        .right,
        .boom {
            width: 50px;
            height: 50px;
            font-size: 24px;
        }
        
        .up,
        .right,
        .down,
        .boom {
            margin-left: 50px;
        }
        
        .up,
        .right,
        .down {
            margin-top: 10px;
        }
        
        .boom {
            margin-top: 50px;
        }
        
        .down {
            margin-bottom: 50px;
        }
        
        input {
            float: none;
        }
    </style>

    <p id="score" style="color: red;">Score:0</p>

    <!-- 画布 -->
    <p id="map"></p>

    <!-- 操作 -->
    <div class="button1" id="button">
        <button onclick="up()" class="up">↑</button><br>
        <button onclick="left()" class="left">←</button>
        <button onclick="right()" class="right">→</button><br>
        <button id="down" onclick="down()" class="down">↓</button>
    </div>
    <div class="button2" id="button">
        <button id="boom" onclick="boom()" class="boom">&#128163;</button><br>
    </div>
    <br>
    <div>
        <hr>
        <button id="save" onclick="save()">保存</button><br>
        <a href="javascript:void(0);" onClick="map_list_hide()" id="map_list_hide">隐藏地图列表</a>
        <a href="javascript:void(0);" onClick="map_list_show()" id="map_list_show">显示地图列表</a><br>
        <div id="editor">
            <a href="javascript:void(0);" onClick="edit(map_list, map_id, map_order)" id="edit">编辑</a>
            <a href="javascript:void(0);" onClick="exit_editing()" id="exit_editing">退出编辑</a><br>
            <ul id="maplist"></ul>
        </div>
    </div>
    <div>
        <hr>
        <input type="CheckBox" id="waterrun">河水蔓延<br>
        <input type="CheckBox" id="grassrun">草地蔓延<br>
        <div id="leftmain">
            <input type="CheckBox" onclick="ischeck(this);" id="left_main">惯用左手<br>
        </div>
        <input type="CheckBox" id="peace" checked="checked">和平<br>
        <input type="CheckBox" id="unmatched">无敌<br>
        <div>
            炸弹威力: <input type="range" id="boom_power" min="0" max="3" onchange="boompowerchange()" value="1"><span id="power">1</span><br>
        </div>
    </div>

    <a href="javascript:void(0);" onClick="show()" id="show">显示地图组件</a><br>

    <div id="hide">
        <hr>
        <textarea id="in" placeholder="导入地图" rows="15" cols="30"></textarea>
        <a href="javascript:void(0);" onClick="process()" id="do_process">加载地图</a><br>
        <a href="mapbuilder.html" id="show">编辑地图</a><br>
        <a href="explain.html" id="show">说明</a><br>
        <a href="javascript:void(0);" onClick="hide()" id="hide">隐藏地图组件</a>
    </div>
    <!--  
----------------→y
|
|
|
|
|
|
↓x -->
    <script>
        var i = 0;
        var j = 0;
        var x_step;
        var y_step;
        x = 0;
        y = 0;
        x_old = 1;
        y_old = 1;
        boom_x = -1;
        boom_y = -1;
        block = "草";
        block_old = "草";
        mob_block = "草";
        mob_block_old = "草";
        mob_x = 1;
        mob_y = 1;
        mob_x_old = 0;
        mob_y_old = 0;

        var booming;

        boom_power = 1;

        var score = 0;

        map = new Array();

        var find_direction_times = 0;
        var find_place_times = 0;

        saved_before = false;

        map_list = new Array;
        map_list_input = new Array;
        map_id = new Array;
        map_id_input = new Array;
        map_order = new Array;
        map_order_input = new Array;

        //定义地图
        map = [
            ["草", "草", "水", "水", "水", "草", "草", "草", "草", "草", "草", "草"],
            ["草", "草", "水", "水", "水", "草", "草", "草", "草", "草", "草", "草"],
            ["草", "草", "水", "水", "水", "草", "草", "草", "草", "草", "草", "草"],
            ["草", "草", "水", "水", "水", "草", "草", "草", "草", "草", "草", "草"],
            ["草", "草", "水", "水", "水", "草", "草", "草", "草", "草", "草", "草"],
            ["草", "草", "水", "水", "水", "水", "水", "水", "桥", "桥", "水", "水"],
            ["草", "草", "水", "水", "水", "水", "水", "水", "桥", "桥", "水", "水"],
            ["草", "草", "水", "水", "水", "水", "水", "水", "桥", "桥", "水", "水"],
            ["草", "草", "草", "草", "草", "草", "草", "草", "草", "草", "草", "草"],
            ["草", "草", "草", "草", "草", "草", "草", "草", "草", "草", "草", "草"],
            ["草", "草", "草", "草", "草", "草", "草", "草", "草", "草", "草", "草"],
            ["草", "草", "草", "草", "草", "草", "草", "草", "草", "草", "草", "草"]
        ];

        word = ["水", "桥", "草", "人", "怪", "土"];
        color = ["blue", "orange", "green", "red", "red", "Sienna"];
        passable = ["草", "桥", "土", "怪"];

        //初始化
        drawmap();
        findwarter();
        findgrass();
        mob_move_prepare();
        boompowerchange();
        map_list_hide();
        browser_alert()
        window.onload = setlist(map_list, map_id, map_order);

        map_input = new Array();
        settings = new Array();

        hide(); //隐藏地图组件

        document.getElementById('exit_editing').style.display = "none";

        if (getCookie("map_list") == "") {
            map_list_input = [];
        } else {
            map_list_input = decodeURIComponent(escape(window.atob(getCookie("map_list")))).split(",");
            map_list = JSON.parse(JSON.stringify(map_list_input)); //https://www.cnblogs.com/Blogzlj/p/13031677.html
        }

        if (getCookie("map_id") == "") {
            map_id_input = [];
        } else {
            map_id_input = decodeURIComponent(escape(window.atob(getCookie("map_id")))).split(",");
            map_id = JSON.parse(JSON.stringify(map_id_input)); //https://www.cnblogs.com/Blogzlj/p/13031677.html
        }

        if (getCookie("map_order") == "") {
            map_order_input = [];
        } else {
            map_order_input = decodeURIComponent(escape(window.atob(getCookie("map_order")))).split(",");
            map_order = JSON.parse(JSON.stringify(map_order_input)); //https://www.cnblogs.com/Blogzlj/p/13031677.html
        }

        // map_list = ["2", "1", "5", "3", "4"];
        // map_id = ["1", "0", "4", "2", "3"];
        // map_order = ["0", "1", "2", "3", "4"];


        if (!IsPc()) { //是PC端
            document.getElementById("boom").style.marginTop = '10px';
            document.getElementById("down").style.marginBottom = '10px';
            document.getElementById('leftmain').style.display = "none";
        } else { //是移动端
            document.getElementById('leftmain').style.display = "block";
            document.getElementById("button").style.cssFloat = "right";
        }

        setlist(map_list, map_id, map_order);

        function getmap(value) {
            var os = getOs(); //获取浏览器信息
            if (os == 'FF' || os == 'SF') { //FireFox、谷歌浏览器用这个
                confirm_text = map_list[map_id.indexOf(value)] + "\n读取这个地图？\n请确保您已经保存好了当前地图！"
                confirm_text = map_list[map_id.indexOf(value)] + "\r\n读取这个地图？\r\n请确保您已经保存好了当前地图！";
            }
            if (confirm(confirm_text)) {
                read(value);
            }
        }

        function setlist(list_input, id_input, order_input) {
            maplist.innerHTML = "";
            for (i = 0; i < list_input.length; i++) {
                //在ul中添加标签
                //获取ul标签
                let maplist = document.getElementById('maplist');
                //添加li元素
                let liObj = document.createElement('li');
                //设置标签样式，当然也可以设置其他的属性值
                // liObj.setAttribute('id', '01');
                //设置标签的文本信息
                liObj.innerHTML = '<a name="' + id_input[id_input.indexOf(order_input[i])] + '" href="javascript:void(0);" onclick="getmap(this.name)">' + list_input[id_input.indexOf(order_input[i])] + '</a>';
                // 把js新建的li放到ul下
                maplist.appendChild(liObj);

            }
        }

        function edit(list_input, id_input, order_input) {
            document.getElementById('edit').style.display = "none";
            document.getElementById('exit_editing').style.display = "block";

            maplist.innerHTML = "";
            for (i = 0; i < list_input.length; i++) {
                //在ul中添加标签
                //获取ul标签
                let maplist = document.getElementById('maplist');
                //添加li元素
                let liObj = document.createElement('li');
                //设置标签样式，当然也可以设置其他的属性值
                // liObj.setAttribute('id', '01');
                //设置标签的文本信息
                liObj.innerHTML = '<a name="' + id_input[id_input.indexOf(order_input[i])] + '" href="javascript:void(0);" onclick="getmap(this.name)">' + list_input[id_input.indexOf(order_input[i])] + '</a>';
                liObj.innerHTML += '<a name="' + id_input[id_input.indexOf(order_input[i])] + '" href="javascript:void(0);" onclick="rename(this.name)">&nbsp;&nbsp;&nbsp;重命名</a>';
                liObj.innerHTML += '<a name="' + id_input[id_input.indexOf(order_input[i])] + '" href="javascript:void(0);" onclick="delete_map(this.name)">&nbsp;&nbsp;&nbsp;删除</a>';
                // 把js新建的li放到ul下
                maplist.appendChild(liObj);

            }
        }

        function exit_editing() {
            setlist(map_list, map_id, map_order);
            document.getElementById('edit').style.display = "block";
            document.getElementById('exit_editing').style.display = "none";
        }

        function IsPc() { //是PC→false，是移动端→true
            let userAgent = navigator.userAgent,
                Agents = ["Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod"];
            console.log('userAgent:', userAgent)
            return Agents.some((i) => {
                return userAgent.includes(i)
            })
        }

        //浏览器类型判定
        function getOs() {
            if (navigator.userAgent.indexOf("MSIE") > 0) {
                return "IE"; //InternetExplor
            } else if (isFirefox = navigator.userAgent.indexOf("Firefox") > 0) {
                return "FF"; //firefox
            } else if (isSafari = navigator.userAgent.indexOf("Safari") > 0) {
                return "SF"; //Safari
            } else if (isCamino = navigator.userAgent.indexOf("Camino") > 0) {
                return "C"; //Camino
            } else if (isMozilla = navigator.userAgent.indexOf("Gecko/") > 0) {
                return "G"; //Gecko
            } else if (isMozilla = navigator.userAgent.indexOf("Opera") >= 0) {
                return "O"; //opera
            } else {
                return 'Other';
            }
        }

        function browser_alert() { //如果是微信或者QQ或者新浪微博内置的浏览器就提醒
            var browser = {
                versions: function() {
                    var u = navigator.userAgent,
                        app = navigator.appVersion;
                    return { //移动终端浏览器版本信息
                        trident: u.indexOf('Trident') > -1, //IE内核
                        presto: u.indexOf('Presto') > -1, //opera内核
                        webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
                        gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
                        mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
                        ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
                        android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或uc浏览器
                        iPhone: u.indexOf('iPhone') > -1, //是否为iPhone或者QQHD浏览器
                        iPad: u.indexOf('iPad') > -1, //是否iPad
                        webApp: u.indexOf('Safari') == -1 //是否web应该程序，没有头部与底部
                    };
                }(),
                language: (navigator.browserLanguage || navigator.language).toLowerCase()
            }

            if (browser.versions.mobile) { //判断是否是移动设备打开。browser代码在下面
                var ua = navigator.userAgent.toLowerCase(); //获取判断用的对象
                if (ua.match(/MicroMessenger/i) == "micromessenger") { //在微信中打开
                    window.alert("您正在使用微信内置的浏览器，将无法进行存档，如需存档请在浏览器里打开本网页！");
                }
                if (ua.match(/WeiBo/i) == "weibo") { //在新浪微博客户端打开
                    window.alert("您正在使用新浪微博客户端内置的浏览器，将无法进行存档，如需存档请在浏览器里打开本网页！");
                }
                if (ua.match(/QQ/i) == "qq") { //在QQ空间打开
                    window.alert("您正在使用QQ内置的浏览器，将无法进行存档，如需存档请在浏览器里打开本网页！");
                }
            }
        }

        function ischeck(e) { //惯用左手
            if (e.checked) {
                document.getElementById("button").style.cssFloat = "left";
            } else {
                document.getElementById("button").style.cssFloat = "right";
            }
        }

        function map_list_show() {
            document.getElementById('editor').style.display = "block";
            document.getElementById('map_list_show').style.display = "none";
            document.getElementById('map_list_hide').style.display = "block";
        }

        function map_list_hide() {
            document.getElementById('editor').style.display = "none";
            document.getElementById('map_list_show').style.display = "block";
            document.getElementById('map_list_hide').style.display = "none";
        }

        function show() { //显示地图组件
            document.getElementById('show').style.display = "none";
            document.getElementById('hide').style.display = "block";
        }

        function hide() { //隐藏地图组件
            document.getElementById('show').style.display = "block";
            document.getElementById('hide').style.display = "none";
        }

        function boompowerchange() {
            boom_power = Number(document.getElementById("boom_power").value);
            document.getElementById("power").innerText = boom_power + 1;
        }

        function setCookie(cname, cvalue, exdays) {
            var d = new Date();
            d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
            var expires = "expires=" + d.toGMTString();
            document.cookie = cname + "=" + cvalue + "; " + expires;
        }

        function getCookie(cname) {
            var name = cname + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i].trim();
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        function rename(rename_map_id) {
            new_worldname = prompt("请输入新的地图名称", "World");
            if (new_worldname != null) {
                map_list[map_id.indexOf(rename_map_id)] = new_worldname;
                map_list_output = btoa(unescape(encodeURIComponent(map_list.join(","))));
                setCookie("map_list", map_list_output, 30 * 365);

                edit(map_list, map_id, map_order);
            }
        }

        function delete_map(delete_id) {
            if (confirm('删除"' + map_list[map_id.indexOf(delete_id)] + '"?')) {
                map_list.splice(map_id.indexOf(delete_id), 1);
                map_id.splice(map_id.indexOf(delete_id), 1);
                map_order.splice(map_order.indexOf(delete_id), 1);

                map_list_output = btoa(unescape(encodeURIComponent(map_list.join(","))));
                setCookie("map_list", map_list_output, 30 * 365);
                map_id_output = btoa(unescape(encodeURIComponent(map_id.join(","))));
                setCookie("map_id", map_id_output, 30 * 365);
                map_order_output = btoa(unescape(encodeURIComponent(map_order.join(","))));
                setCookie("map_order", map_order_output, 30 * 365);

                setCookie(delete_id, map_order_output, -1);
                setCookie(delete_id + "_settings", map_order_output, -1);

                edit(map_list, map_id, map_order);
            }
        }

        function save() {
            map_length = map.length - 1;
            map_output = [];
            map_output = JSON.parse(JSON.stringify(map)); //https://www.cnblogs.com/Blogzlj/p/13031677.html
            map_output[x][y] = block;
            if (!peace.checked) {
                map_output[mob_x][mob_y] = mob_block;
            }
            map_output[map_length + 1] = word;
            map_output[map_length + 2] = color;
            map_output[map_length + 3] = passable;

            settings = [];
            settings[0] = [x, y, x_old, y_old, block, block_old];
            settings[1] = [mob_x, mob_y, mob_x_old, mob_y_old, mob_block, mob_block_old];
            settings[2] = score;
            settings[3] = ["waterrun", "grassrun", "left_main", "peace", "unmatched", "boom_power"]
            settings[4] = [waterrun.checked, grassrun.checked, left_main.checked, peace.checked, unmatched.checked, Number(document.getElementById("boom_power").value)];
            save_output = btoa(unescape(encodeURIComponent(map_output.join(";")))); //https://www.itdaan.com/blog/2014/04/22/34c1a969a1dadf56cf6767d4ae48e402.html
            save_output_settings = btoa(unescape(encodeURIComponent(settings.join(";"))));
            // window.alert(save_output);
            if (!saved_before) {
                worldname = prompt("请输入地图名称", "World");
                if (worldname != null) {
                    this_map_id = map_id.length;
                    map_id[map_id.length] = this_map_id.toString();
                    map_order.unshift(this_map_id.toString());

                    map_list[map_list.length] = worldname;
                    saved_before = true;
                    map_list_output = btoa(unescape(encodeURIComponent(map_list.join(","))));
                    setCookie("map_list", map_list_output, 30 * 365);
                    map_id_output = btoa(unescape(encodeURIComponent(map_id.join(","))));
                    setCookie("map_id", map_id_output, 30 * 365);
                    map_order_output = btoa(unescape(encodeURIComponent(map_order.join(","))));
                    setCookie("map_order", map_order_output, 30 * 365);

                    setCookie(this_map_id, save_output, 30 * 365);
                    setCookie(this_map_id + "_settings", save_output_settings, 30 * 365);

                    setlist(map_list, map_id, map_order);
                }
            } else {
                map_order.forEach(function(item, index, arr) {
                    if (item === this_map_id.toString()) {
                        arr.splice(index, 1);
                    }
                });
                map_order.unshift(this_map_id.toString());

                map_list_output = btoa(unescape(encodeURIComponent(map_list.join(","))));
                setCookie("map_list", map_list_output, 30 * 365);
                map_id_output = btoa(unescape(encodeURIComponent(map_id.join(","))));
                setCookie("map_id", map_id_output, 30 * 365);
                map_order_output = btoa(unescape(encodeURIComponent(map_order.join(","))));
                setCookie("map_order", map_order_output, 30 * 365);

                setCookie(this_map_id, save_output, 30 * 365);
                setCookie(this_map_id + "_settings", save_output_settings, 30 * 365);

                setlist(map_list, map_id, map_order);
            }
        }

        function read(map_id_input) {
            settings_input = decodeURIComponent(escape(window.atob(getCookie(map_id_input + "_settings")))).split(";");

            this_map_id = Number(map_id_input);
            saved_before = true;

            document.getElementById('edit').style.display = "block";
            document.getElementById('exit_editing').style.display = "none";

            map_order.forEach(function(item, index, arr) {
                if (item === map_id_input.toString()) {
                    arr.splice(index, 1);
                }
            });
            map_order.unshift(map_id_input.toString());

            setlist(map_list, map_id, map_order);

            for (i = 0; i < settings_input.length; i++) {
                settings_input[i] = settings_input[i].split(","); //沿","分割
            }
            for (ch = 0; ch < settings_input[3].length - 1; ch++) {
                document.getElementById(settings_input[3][ch]).checked = eval(settings_input[4][ch]);
            }
            boom_power = Number(settings_input[4][settings_input[4].length - 1]);
            document.getElementById("boom_power").value = boom_power;
            document.getElementById("power").innerText = boom_power + 1;

            if (IsPc()) {
                document.getElementById('leftmain').style.display = "block";
                document.getElementById("button").style.cssFloat = "right";
            }
            document.getElementById("in").value = decodeURIComponent(escape(window.atob(getCookie(map_id_input))));
            var ee = document.getElementById("in");
            var lines = ee.value.split(";"); //沿";"分割
            for (i = 0; i < lines.length; i++) {
                map_input[i] = lines[i].split(","); //沿","分割
            }
            for (g = 0; g < map_input.length - 3; g++) { //除去最后三行，剩下的赋值给map数组
                map[g] = map_input[g];
            }
            word = map_input[map_input.length - 3]; //倒数第三行是新的word数组
            color = map_input[map_input.length - 2]; //倒数第二行是新的color数组
            passable = map_input[map_input.length - 1]; //倒数第一行是新的passable数组

            map[x][y] = map_input[x][y];
            // map[0][0] = map_input[0][0];
            x = Number(settings_input[0][0]);
            y = Number(settings_input[0][1]);
            x_old = Number(settings_input[0][2]);
            y_old = Number(settings_input[0][3]);
            block = settings_input[0][4];
            block_old = settings_input[0][5];
            mob_x = Number(settings_input[1][0]);
            mob_y = Number(settings_input[1][1]);
            mob_x_old = Number(settings_input[1][2]);
            mob_y_old = Number(settings_input[1][3]);
            mob_block = settings_input[1][4];
            mob_block_old = settings_input[1][5];
            score = Number(settings_input[2]);
            document.getElementById("score").innerHTML = "Score:" + score;
            drawmap();

            map_order_output = btoa(unescape(encodeURIComponent(map_order.join(","))));
            setCookie("map_order", map_order_output, 30 * 365);
        }

        function drawmap_base() {
            map[x][y] = '人';
            if (!peace.checked && !booming) {
                map[mob_x][mob_y] = "怪";
            }
            if (boom_x != -1 && boom_y != -1) { //有人放了炸弹
                map[boom_x][boom_y] = "&#128163";
            }
            //画地图
            document.getElementById("map").innerHTML = "";
            for (i = 0; i < map.length; i++) {
                var line = "";
                for (j = 0; j < map[i].length; j++) {
                    if (map[i][j] == "水_new") { //新生成的水变成普通的水，"水_new"是为了防止水蔓延的时候一次刷新多格（新手保护？）
                        line += "水";
                        map[i][j] = "水";
                    } else if (map[i][j] == "草_new") { //新生成的草变成普通的草，"草_new"是为了防止草蔓延的时候一次刷新多格（新手保护？）
                        line += "草";
                        map[i][j] = "草";
                    } else if ((peace.checked || booming) && map[i][j] == "怪") {
                        line += "土";
                        map[i][j] = "土";
                    } else {
                        line += map[i][j];
                    }
                }
                document.getElementById("map").innerHTML += line + "<br>";

            }

            //地图着色
            for (i = 0; i < word.length; i++) {
                var oBox = document.getElementById("map");
                var oContent = oBox.innerHTML;
                var val = word[i];
                var findText = oContent.split(val);
                oBox.innerHTML = findText.join('<span style="color:' + color[i] + ';">' + val + '</span>');
            }
        }

        function drawmap() { //画地图
            if (map[x_old][y_old] != "炸" && map[x_old][y_old] != "土") { //如果没被爆炸波及
                map[x_old][y_old] = block_old; //上一步所在的方块
            }
            drawmap_base();
        }

        // 判断元素是否在数组内的函数，使用方法：contains(Array，元素)，返回true或false
        function contains(arr, obj) {
            var i = arr.length;
            while (i--) {
                if (arr[i] === obj) {
                    return true;
                }
            }
            return false;
        }

        function process() { //加载导入的地图
            var ee = document.getElementById("in");
            var lines = ee.value.split(";"); //沿";"分割
            for (i = 0; i < lines.length; i++) {
                map_input[i] = lines[i].split(","); //沿","分割
            }
            for (g = 0; g < map_input.length - 3; g++) { //除去最后三行，剩下的赋值给map数组
                map[g] = map_input[g];
            }
            word = map_input[map_input.length - 3]; //倒数第三行是新的word数组
            color = map_input[map_input.length - 2]; //倒数第二行是新的color数组
            passable = map_input[map_input.length - 1]; //倒数第一行是新的passable数组

            x = 0; //“人”回到初始位置
            y = 0;

            block = map_input[0][0];
            mob_block = map_input[mob_x][mob_y];

            drawmap_base();
        }

        function mob_move_prepare() { //怪物移动的方向与步数确定
            if (find_direction_times < 10) { //尝试10次寻找方向
                mob_direction = Math.floor(Math.random() * 4);

                switch (mob_direction) {
                    case 0:
                        { //上
                            if (mob_x - 1 > -1 && (contains(passable, map[mob_x - 1][mob_y]) || map[mob_x - 1][mob_y] == "人" || map[mob_x - 1][mob_y] == "炸")) {
                                mob_step = Math.floor(Math.random() * map.length);
                                mob_move(-mob_step, 0);
                                // console.log("0");
                                find_direction_times = 0;
                            } else {
                                find_direction_times += 1;
                                mob_move_prepare();
                            }
                            break;
                        }
                    case 1:
                        { //下
                            if (mob_x + 1 < map.length && (contains(passable, map[mob_x + 1][mob_y]) || map[mob_x + 1][mob_y] == "人" || map[mob_x + 1][mob_y] == "炸")) {
                                mob_step = Math.floor(Math.random() * map.length);
                                mob_move(mob_step, 0);
                                // console.log("1");
                                find_direction_times = 0;
                            } else {
                                find_direction_times += 1;
                                mob_move_prepare();
                            }
                            break;
                        }
                    case 2:
                        { //左
                            if (mob_y - 1 > -1 && (contains(passable, map[mob_x][mob_y - 1]) || map[mob_x][mob_y - 1] == "人" || map[mob_x][mob_y - 1] == "炸")) {
                                mob_step = Math.floor(Math.random() * map[0].length);
                                mob_move(0, -mob_step);
                                // console.log("2");
                                find_direction_times = 0;
                            } else {
                                find_direction_times += 1;
                                mob_move_prepare();
                            }
                            break;
                        }
                    case 3:
                        { //右
                            if (mob_y + 1 < map.length && (contains(passable, map[mob_x][mob_y + 1]) || map[mob_x][mob_y + 1] == "人" || map[mob_x][mob_y + 1] == "炸")) {
                                mob_step = Math.floor(Math.random() * map[0].length);
                                mob_move(0, mob_step);
                                // console.log("3");
                                find_direction_times = 0;
                            } else {
                                find_direction_times += 1;
                                mob_move_prepare();

                            }
                            break;
                        }
                }
                console.log(1);
            } else { //10次都没找到能走的方向(运气不佳)
                //依次将上下左右检测一遍
                if (mob_x - 1 > -1 && (contains(passable, map[mob_x - 1][mob_y]) || map[mob_x - 1][mob_y] == "人" || map[mob_x - 1][mob_y] == "炸")) {
                    mob_step = Math.floor(Math.random() * map.length);
                    mob_move(-mob_step, 0);
                } else if (mob_x + 1 < map.length && (contains(passable, map[mob_x + 1][mob_y]) || map[mob_x + 1][mob_y] == "人" || map[mob_x + 1][mob_y] == "炸")) {
                    mob_step = Math.floor(Math.random() * map.length);
                    mob_move(mob_step, 0);
                } else if (mob_y - 1 > -1 && (contains(passable, map[mob_x][mob_y - 1]) || map[mob_x][mob_y - 1] == "人" || map[mob_x][mob_y - 1] == "炸")) {
                    mob_step = Math.floor(Math.random() * map[0].length);
                    mob_move(0, -mob_step);
                } else if (mob_y + 1 < map.length && (contains(passable, map[mob_x][mob_y + 1]) || map[mob_x][mob_y + 1] == "人" || map[mob_x][mob_y + 1] == "炸")) {
                    mob_step = Math.floor(Math.random() * map[0].length);
                    mob_move(0, mob_step);
                } else { //上下左右都走不了(不是运气的事了)
                    // 休眠，每隔一秒重新检测一次
                    console.log("sleep");
                    setTimeout("mob_move_prepare()", 1000);
                }
            }
            // console.log(mob_direction, mob_step);
        }

        // 怪物运动解算
        function mob_move(x_add, y_add) {
            if (x_add != 0) { //计算在x轴方向上需要走的步数
                x_step = x_add / Math.abs(x_add);
                y_step = 0;
            } else { //计算在y轴方向上需要走的步数
                x_step = 0;
                y_step = y_add / Math.abs(y_add);
            }

            d = 0;

            do_mob_onmove = setTimeout("mob_onmove()", 1000);

        }

        function mob_onmove() { //怪物运动绘图
            if (!peace.checked) { //如果不是和平模式
                if (-1 < mob_x + x_step && mob_x + x_step < map.length && -1 < mob_y + y_step && mob_y + y_step < map[0].length) { //如果能走
                    if (contains(passable, map[mob_x + x_step][mob_y + y_step])) {
                        mob_x_old = mob_x;
                        mob_y_old = mob_y;
                        mob_block_old = mob_block; //下一步将要走到的方块
                        mob_block = map[mob_x + x_step][mob_y + y_step]; //走一步

                        map[mob_x_old][mob_y_old] = mob_block_old; //上一步所在的方块

                        mob_x += x_step;
                        mob_y += y_step;

                        drawmap_base();
                    } else if (map[mob_x + x_step][mob_y + y_step] == "人") { //如果下一步碰到了"人"
                        gameover(0);
                    }
                }
            }

            d++;

            if (d < Math.abs(mob_step)) { //没走完步数
                do_mob_onmove = setTimeout("mob_onmove()", 200); //200毫秒后走下一步
            } else {
                setTimeout("mob_move_prepare()", 200); //重新走
            }
        }

        function mobrestart() { //mob被击杀后刷新
            booming = false; //炸完了
            find_place_times = 0;
            score += 1;
            document.getElementById("score").innerHTML = "Score:" + score;

            do { //寻找落脚点，最多重复10次
                new_mob_x = Math.floor(Math.random() * map.length);
                new_mob_y = Math.floor(Math.random() * map[0].length);
                find_place_times += 1;
                if (find_place_times < 10) {
                    break;
                    find_place_times = 0;
                }
            } while (contains(passable, map[new_mob_x][new_mob_y]));
            outer:
                if (find_place_times != 0) { //运气不好，10次都没找到可以落脚的方块
                    for (f = map.length - 1; f > -1; f--) { //把整个地图都检查一遍，寻找可以落脚的方块
                        for (s = map[0].length - 1; s > -1; s--) {
                            if (contains(passable, map[f][s])) { //找到了就在这里落脚
                                new_mob_x = f;
                                new_mob_y = s;
                                break outer;
                            }
                        }
                    }
                }

                //如果还没找到的话就放弃，直接在随机到的方块上落脚(不是运气的事了)
            mob_x = new_mob_x;
            mob_y = new_mob_y;
            mob_block = map[mob_x][mob_y];
        }

        // 移动
        function left() {
            if (y > 0 && contains(passable, map[x][y - 1])) { //如果不会出地图并且前面的方块可以踩上去
                if (map[x][y - 1] == "怪") {
                    gameover(0);
                } else {
                    block_old = block; //block_old更新为当前所在的方块（block：当前所在的方块 block_old：上一个走过的方块）
                    block = map[x][y - 1]; //block更新为即将走到的方块
                    x_old = x;
                    y_old = y;
                    y -= 1;
                    drawmap();
                }
            }
        }

        function right() {
            if (y < map[x].length - 1 && contains(passable, map[x][y + 1])) {
                if (map[x][y + 1] == "怪") {
                    gameover(0);
                } else {
                    block_old = block;
                    block = map[x][y + 1];
                    x_old = x;
                    y_old = y;
                    y += 1;
                    drawmap();
                }
            }
        }

        function up() {
            if (x > 0 && contains(passable, map[x - 1][y])) {
                if (map[x - 1][y] == "怪") {
                    gameover(0);
                } else {
                    block_old = block;
                    block = map[x - 1][y];
                    x_old = x;
                    y_old = y;
                    x -= 1;
                    drawmap();
                }
            }
        }

        function down() {
            if (x < map.length - 1 && contains(passable, map[x + 1][y])) {
                if (map[x + 1][y] == "怪") {
                    gameover(0);
                } else {
                    block_old = block;
                    block = map[x + 1][y];
                    x_old = x;
                    y_old = y;
                    x += 1;
                    drawmap();
                }
            }
        }

        // 放炸弹
        function boom() {
            if (boom_x == -1 && boom_y == -1) { //如果没有炸弹（炸弹只能存在一个）
                boom_x = x;
                boom_y = y;
                boom_x_old = x;
                boom_y_old = y;
                document.getElementById("boom").disabled = true;
                setTimeout("explode()", 3000); //延时3秒爆炸
            }
            drawmap_base();
        }

        // 爆炸特效（周围一圈“炸”）
        function explode() {
            for (q = -1 - boom_power; q < 2 + boom_power; q++) {
                for (w = -1 - boom_power; w < 2 + boom_power; w++) {
                    if (boom_x + q > -1 && boom_y + w > -1 && boom_x + q < map.length && boom_y + w < map[boom_x].length) {
                        if (map[boom_x + q][boom_y + w] == "人") {
                            var over = true;
                        } else if (map[boom_x + q][boom_y + w] == "怪") {
                            booming = true;
                            setTimeout("mobrestart()", 3000);
                        }
                        map[boom_x + q][boom_y + w] = "炸";
                    }
                }
            }
            boom_x = -1; //清除炸弹
            boom_y = -1;
            if (over) {
                gameover(1);
            }
            drawmap();
            setTimeout("replace()", 1000); //过一秒后清除特效，替换为“土”
        }

        // 清除特效，替换为“土”
        function replace() {
            for (e = -1 - boom_power; e < 2 + boom_power; e++) {
                for (r = -1 - boom_power; r < 2 + boom_power; r++) {
                    if (boom_x_old + e > -1 && boom_y_old + r > -1 && boom_x_old + e < map.length && boom_y_old + r < map[boom_x_old].length) {
                        map[boom_x_old + e][boom_y_old + r] = "土";
                    }
                }
            }
            drawmap();
            document.getElementById("boom").disabled = false;
        }

        // 河水蔓延
        function findwarter() {
            if (waterrun.checked) { //如果开启河水蔓延
                for (o = 0; o < map.length; o++) { //遍历全图，寻找“土”
                    for (u = 0; u < map[o].length; u++) {
                        if (map[o][u] == "土") {
                            for (q = -1; q < 2; q++) { //找到“土”，在土周围3x3区域寻找“水”
                                for (w = -1; w < 2; w++) {
                                    if (o + q > -1 && u + w > -1 && o + q < map.length && u + w < map[o].length) {
                                        if (map[o + q][u + w] == "水") { //如果周围有水
                                            map[o][u] = "水_new"; //“土”替换为“水_new”（“水_new”是新生成的水源，绘图时会被刷新为普通水源）
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                drawmap_base();

            }
            setTimeout("findwarter()", 1000); //间隔一秒重复执行
        }

        // 草地蔓延
        function findgrass() {
            if (grassrun.checked) { //如果开启草地蔓延
                for (o = 0; o < map.length; o++) { //遍历全图，寻找“土”
                    for (u = 0; u < map[o].length; u++) {
                        if (map[o][u] == "土") {
                            for (q = -1; q < 2; q++) { //找到“土”，在土周围3x3区域寻找“草”
                                for (w = -1; w < 2; w++) {
                                    if (o + q > -1 && u + w > -1 && o + q < map.length && u + w < map[o].length) {
                                        if (map[o + q][u + w] == "草") { //如果周围有草地
                                            if (Math.floor(Math.random() * 10) == 9) {
                                                map[o][u] = "草_new"; //“土”替换为“草_new”(一半概率)(“草_new”是新生成的草地，绘图时会被刷新为普通草地)
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                drawmap_base();

            }
            setTimeout("findgrass()", 5000); //间隔五秒重复执行
        }

        function gameover(reason) { //0：碰到mob 1：被炸死
            if (!unmatched.checked) {
                if (reason == 0) {
                    map[x][y] = '<span style="color: red;">怪</span>';
                    point_out = "你 被 怪物 击败了！";
                } else {
                    point_out = "你 爆炸了！";
                }


                //画地图
                document.getElementById("map").innerHTML = "";
                for (i = 0; i < map.length; i++) {
                    var line = "";
                    for (j = 0; j < map[i].length; j++) {
                        if (map[i][j] != "水_new") {
                            line += map[i][j];
                        } else { //新生成的水变成普通的水，"水_new"是为了防止水蔓延的时候一次刷新多格（新手保护？）
                            line += "水";
                            map[i][j] = "水";
                        }
                    }
                    document.getElementById("map").innerHTML += line + "<br>";

                }

                //地图着色
                for (i = 0; i < word.length; i++) {
                    var oBox = document.getElementById("map");
                    var oContent = oBox.innerHTML;
                    var val = word[i];
                    var findText = oContent.split(val);
                    oBox.innerHTML = findText.join('<span style="color:' + color[i] + ';">' + val + '</span>');
                }

                var os = getOs(); //获取浏览器信息
                if (os == 'FF' || os == 'SF') { //FireFox、谷歌浏览器用这个
                    alert('游戏结束！\n' + point_out);
                } else { //IE系列用这个
                    alert('游戏结束！\r\n' + point_out);
                }
                location.reload();
            }
        }
    </script>

</body>

</html>