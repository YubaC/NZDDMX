<!DOCTYPE html>
<html lang="zh_cn">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordGame</title>
</head>

<body>
    <style>
        button {
            width: 50px;
            height: 50px;
            font-size: 24px;
        }
        
        .up,
        .right,
        .down,
        .boom {
            margin-left: 50px;
        }
        
        .up,
        .right,
        .down {
            margin-top: 10px;
        }
        
        .boom {
            margin-top: 50px;
        }
        
        .down {
            margin-bottom: 50px;
        }
        
        input {
            float: none;
        }
    </style>

    <p id="score" style="color: red;">Score:0</p>

    <!-- 画布 -->
    <p id="map"></p>

    <!-- 操作 -->
    <div class="button1" id="button">
        <button onclick="up()" class="up">↑</button><br>
        <button onclick="left()" class="left">←</button>
        <button onclick="right()" class="right">→</button><br>
        <button id="down" onclick="down()" class="down">↓</button>
    </div>
    <div class="button2" id="button">
        <button id="boom" onclick="boom()" class="boom">&#128163;</button><br>
    </div>
    <br>
    <div>
        <hr>
        <input type="CheckBox" id="waterrun">河水蔓延<br>
        <div id="leftmain">
            <input type="CheckBox" onclick="ischeck(this);">惯用左手<br>
        </div>
        <input type="CheckBox" id="peace" checked="checked">和平<br>
        <input type="CheckBox" id="unmatched">无敌<br>
        <div>
            炸弹威力: <input type="range" id="boom_power" min="0" max="3" onchange="boompowerchange()" value="1"><span id="power">1</span><br>
        </div>
    </div>

    <a href="javascript:void(0);" onClick="show()" id="show">显示地图组件</a><br>

    <div id="hide">
        <hr>
        <textarea id="in" placeholder="导入地图" rows="15" cols="30"></textarea>
        <a href="javascript:void(0);" onClick="process()" id="do_process">加载地图</a><br>
        <a href="mapbuilder.html" id="show">编辑地图</a><br>
        <a href="explain.html" id="show">说明</a><br>
        <a href="javascript:void(0);" onClick="hide()" id="hide">隐藏地图组件</a>
    </div>
    <!--  
----------------→y
|
|
|
|
|
|
↓x -->
    <script>
        var i = 0;
        var j = 0;
        var x_step;
        var y_step;
        x = 0;
        y = 0;
        x_old = 1;
        y_old = 1;
        boom_x = -1;
        boom_y = -1;
        block = "草";
        block_old = "草";
        mob_block = "草";
        mob_block_old = "草";
        mob_x = 1;
        mob_y = 1;
        mob_x_old = 0;
        mob_y_old = 0;

        var booming;

        boom_power = 1;

        var score = 0;

        map = new Array();

        var find_direction_times = 0;
        var find_place_times = 0;

        //定义地图
        map = [
            ["草", "草", "水", "水", "水", "草", "草", "草", "草", "草", "草", "草"],
            ["草", "草", "水", "水", "水", "草", "草", "草", "草", "草", "草", "草"],
            ["草", "草", "水", "水", "水", "草", "草", "草", "草", "草", "草", "草"],
            ["草", "草", "水", "水", "水", "草", "草", "草", "草", "草", "草", "草"],
            ["草", "草", "水", "水", "水", "草", "草", "草", "草", "草", "草", "草"],
            ["草", "草", "水", "水", "水", "水", "水", "水", "桥", "桥", "水", "水"],
            ["草", "草", "水", "水", "水", "水", "水", "水", "桥", "桥", "水", "水"],
            ["草", "草", "水", "水", "水", "水", "水", "水", "桥", "桥", "水", "水"],
            ["草", "草", "草", "草", "草", "草", "草", "草", "草", "草", "草", "草"],
            ["草", "草", "草", "草", "草", "草", "草", "草", "草", "草", "草", "草"],
            ["草", "草", "草", "草", "草", "草", "草", "草", "草", "草", "草", "草"],
            ["草", "草", "草", "草", "草", "草", "草", "草", "草", "草", "草", "草"]
        ];

        word = ["水", "桥", "草", "人", "怪", "土"];
        color = ["blue", "orange", "green", "red", "red", "Sienna"];
        passable = ["草", "桥", "土", "怪"];

        //初始化
        drawmap();
        findwarter();
        mob_move_prepare();
        boompowerchange();

        map_input = new Array();

        hide(); //隐藏地图组件

        if (!IsPc()) { //是PC端
            document.getElementById("boom").style.marginTop = '10px';
            document.getElementById("down").style.marginBottom = '10px';
            document.getElementById('leftmain').style.display = "none";
        } else { //是移动端
            document.getElementById('leftmain').style.display = "block";
            document.getElementById("button").style.cssFloat = "right";
        }

        function IsPc() { //是PC→false，是移动端→true
            let userAgent = navigator.userAgent,
                Agents = ["Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod"];
            console.log('userAgent:', userAgent)
            return Agents.some((i) => {
                return userAgent.includes(i)
            })
        }

        function ischeck(e) { //惯用左手
            if (e.checked) {
                document.getElementById("button").style.cssFloat = "left";
            } else {
                document.getElementById("button").style.cssFloat = "right";
            }
        }

        function show() { //显示地图组件
            document.getElementById('show').style.display = "none";
            document.getElementById('hide').style.display = "block";
        }

        function hide() { //隐藏地图组件
            document.getElementById('show').style.display = "block";
            document.getElementById('hide').style.display = "none";
        }

        function boompowerchange() {
            boom_power = Number(document.getElementById("boom_power").value);
            document.getElementById("power").innerText = boom_power;
        }

        function drawmap_base() {
            map[x][y] = '人';
            if (!peace.checked && !booming) {
                map[mob_x][mob_y] = "怪";
            }
            if (boom_x != -1 && boom_y != -1) { //有人放了炸弹
                map[boom_x][boom_y] = "&#128163";
            }
            //画地图
            document.getElementById("map").innerHTML = "";
            for (i = 0; i < map.length; i++) {
                var line = "";
                for (j = 0; j < map[i].length; j++) {
                    if (map[i][j] == "水_new") { //新生成的水变成普通的水，"水_new"是为了防止水蔓延的时候一次刷新多格（新手保护？）
                        line += "水";
                        map[i][j] = "水";
                    } else if ((peace.checked || booming) && map[i][j] == "怪") {
                        line += "土";
                    } else {
                        line += map[i][j];
                    }
                }
                document.getElementById("map").innerHTML += line + "<br>";

            }

            //地图着色
            for (i = 0; i < word.length; i++) {
                var oBox = document.getElementById("map");
                var oContent = oBox.innerHTML;
                var val = word[i];
                var findText = oContent.split(val);
                oBox.innerHTML = findText.join('<span style="color:' + color[i] + ';">' + val + '</span>');
            }
        }

        function drawmap() { //画地图
            if (map[x_old][y_old] != "炸" && map[x_old][y_old] != "土") { //如果没被爆炸波及
                map[x_old][y_old] = block_old; //上一步所在的方块
            }
            drawmap_base();
        }

        // 判断元素是否在数组内的函数，使用方法：contains(Array，元素)，返回true或false
        function contains(arr, obj) {
            var i = arr.length;
            while (i--) {
                if (arr[i] === obj) {
                    return true;
                }
            }
            return false;
        }

        function process() { //加载导入的地图
            var ee = document.getElementById("in");
            var lines = ee.value.split(";"); //沿";"分割
            for (i = 0; i < lines.length; i++) {
                map_input[i] = lines[i].split(","); //沿","分割
            }
            for (g = 0; g < map_input.length - 3; g++) { //除去最后三行，剩下的赋值给map数组
                map[g] = map_input[g];
            }
            word = map_input[map_input.length - 3]; //倒数第三行是新的word数组
            color = map_input[map_input.length - 2]; //倒数第二行是新的color数组
            passable = map_input[map_input.length - 1]; //倒数第一行是新的passable数组

            x = 0; //“人”回到初始位置
            y = 0;

            block = map_input[0][0];
            mob_block = map_input[mob_x][mob_y];

            drawmap_base();
        }

        function mob_move_prepare() {
            if (find_direction_times < 10) {
                mob_direction = Math.floor(Math.random() * 4);

                switch (mob_direction) {
                    case 0:
                        { //上
                            if (mob_x - 1 > -1 && (contains(passable, map[mob_x - 1][mob_y]) || map[mob_x - 1][mob_y] == "人" || map[mob_x - 1][mob_y] == "炸")) {
                                mob_step = Math.floor(Math.random() * map.length);
                                mob_move(-mob_step, 0);
                                // console.log("0");
                                find_direction_times = 0;
                            } else {
                                find_direction_times += 1;
                                mob_move_prepare();
                            }
                            break;
                        }
                    case 1:
                        { //下
                            if (mob_x + 1 < map.length && (contains(passable, map[mob_x + 1][mob_y]) || map[mob_x + 1][mob_y] == "人" || map[mob_x + 1][mob_y] == "炸")) {
                                mob_step = Math.floor(Math.random() * map.length);
                                mob_move(mob_step, 0);
                                // console.log("1");
                                find_direction_times = 0;
                            } else {
                                find_direction_times += 1;
                                mob_move_prepare();
                            }
                            break;
                        }
                    case 2:
                        { //左
                            if (mob_y - 1 > -1 && (contains(passable, map[mob_x][mob_y - 1]) || map[mob_x][mob_y - 1] == "人" || map[mob_x][mob_y - 1] == "炸")) {
                                mob_step = Math.floor(Math.random() * map[0].length);
                                mob_move(0, -mob_step);
                                // console.log("2");
                                find_direction_times = 0;
                            } else {
                                find_direction_times += 1;
                                mob_move_prepare();
                            }
                            break;
                        }
                    case 3:
                        { //右
                            if (mob_y + 1 < map.length && (contains(passable, map[mob_x][mob_y + 1]) || map[mob_x][mob_y + 1] == "人" || map[mob_x][mob_y + 1] == "炸")) {
                                mob_step = Math.floor(Math.random() * map[0].length);
                                mob_move(0, mob_step);
                                // console.log("3");
                                find_direction_times = 0;
                            } else {
                                find_direction_times += 1;
                                mob_move_prepare();

                            }
                            break;
                        }
                }
                console.log(1);
            } else {
                if (mob_x - 1 > -1 && (contains(passable, map[mob_x - 1][mob_y]) || map[mob_x - 1][mob_y] == "人" || map[mob_x - 1][mob_y] == "炸")) {
                    mob_step = Math.floor(Math.random() * map.length);
                    mob_move(-mob_step, 0);
                } else if (mob_x + 1 < map.length && (contains(passable, map[mob_x + 1][mob_y]) || map[mob_x + 1][mob_y] == "人" || map[mob_x + 1][mob_y] == "炸")) {
                    mob_step = Math.floor(Math.random() * map.length);
                    mob_move(mob_step, 0);
                } else if (mob_y - 1 > -1 && (contains(passable, map[mob_x][mob_y - 1]) || map[mob_x][mob_y - 1] == "人" || map[mob_x][mob_y - 1] == "炸")) {
                    mob_step = Math.floor(Math.random() * map[0].length);
                    mob_move(0, -mob_step);
                } else if (mob_y + 1 < map.length && (contains(passable, map[mob_x][mob_y + 1]) || map[mob_x][mob_y + 1] == "人" || map[mob_x][mob_y + 1] == "炸")) {
                    mob_step = Math.floor(Math.random() * map[0].length);
                    mob_move(0, mob_step);
                } else {
                    console.log("sleep");
                    setTimeout("mob_move_prepare()", 1000);
                }
            }
            // console.log(mob_direction, mob_step);
        }

        function mob_move(x_add, y_add) {
            if (x_add != 0) {
                x_step = x_add / Math.abs(x_add);
                y_step = 0;
            } else {
                x_step = 0;
                y_step = y_add / Math.abs(y_add);
            }

            d = 0;

            do_mob_onmove = setTimeout("mob_onmove()", 1000);

        }

        function mob_onmove() {
            if (!peace.checked) {
                if (-1 < mob_x + x_step && mob_x + x_step < map.length && -1 < mob_y + y_step && mob_y + y_step < map[0].length) {
                    if (contains(passable, map[mob_x + x_step][mob_y + y_step])) {
                        mob_x_old = mob_x;
                        mob_y_old = mob_y;
                        mob_block_old = mob_block;
                        mob_block = map[mob_x + x_step][mob_y + y_step];

                        map[mob_x_old][mob_y_old] = mob_block_old; //上一步所在的方块

                        mob_x += x_step;
                        mob_y += y_step;

                        drawmap_base();
                    } else if (map[mob_x + x_step][mob_y + y_step] == "人") {
                        gameover(1);
                    }
                }
            }

            d++;

            if (d < Math.abs(mob_step)) {
                do_mob_onmove = setTimeout("mob_onmove()", 200);
            } else {
                setTimeout("mob_move_prepare()", 200);
            }
        }

        function mobrestart() {
            booming = false;
            find_place_times = 0;
            score += 1;
            document.getElementById("score").innerHTML = "Score:" + score;

            do {
                new_mob_x = Math.floor(Math.random() * map.length);
                new_mob_y = Math.floor(Math.random() * map[0].length);
                find_place_times += 1;
                if (find_place_times < 10) {
                    break;
                    find_place_times = 0;
                }
            } while (contains(passable, map[new_mob_x][new_mob_y]));
            outer:
                if (find_place_times != 0) {
                    for (f = map.length - 1; f > -1; f--) {
                        console.log(f);
                        for (s = map[0].length - 1; s > -1; s--) {
                            console.log(s);
                            if (contains(passable, map[f][s])) {
                                new_mob_x = f;
                                new_mob_y = s;
                                break outer;
                            }
                        }
                    }
                }

            mob_x = new_mob_x;
            mob_y = new_mob_y;
            mob_block = map[mob_x][mob_y];
        }

        // 移动
        function left() {
            if (y > 0 && contains(passable, map[x][y - 1])) { //如果不会出地图并且前面的方块可以踩上去
                if (map[x][y - 1] == "怪") {
                    gameover(0);
                } else {
                    block_old = block; //block_old更新为当前所在的方块（block：当前所在的方块 block_old：上一个走过的方块）
                    block = map[x][y - 1]; //block更新为即将走到的方块
                    x_old = x;
                    y_old = y;
                    y -= 1;
                    drawmap();
                }
            }
        }

        function right() {
            if (y < map[x].length - 1 && contains(passable, map[x][y + 1])) {
                if (map[x][y + 1] == "怪") {
                    gameover(0);
                } else {
                    block_old = block;
                    block = map[x][y + 1];
                    x_old = x;
                    y_old = y;
                    y += 1;
                    drawmap();
                }
            }
        }

        function up() {
            if (x > 0 && contains(passable, map[x - 1][y])) {
                if (map[x - 1][y] == "怪") {
                    gameover(0);
                } else {
                    block_old = block;
                    block = map[x - 1][y];
                    x_old = x;
                    y_old = y;
                    x -= 1;
                    drawmap();
                }
            }
        }

        function down() {
            if (x < map.length - 1 && contains(passable, map[x + 1][y])) {
                if (map[x + 1][y] == "怪") {
                    gameover(0);
                } else {
                    block_old = block;
                    block = map[x + 1][y];
                    x_old = x;
                    y_old = y;
                    x += 1;
                    drawmap();
                }
            }
        }

        // 放炸弹
        function boom() {
            if (boom_x == -1 && boom_y == -1) { //如果没有炸弹（炸弹只能存在一个）
                boom_x = x;
                boom_y = y;
                boom_x_old = x;
                boom_y_old = y;
                document.getElementById("boom").disabled = true;
                setTimeout("explode()", 3000); //延时3秒爆炸
            }
            drawmap_base();
        }

        // 爆炸特效（周围一圈“炸”）
        function explode() {
            for (q = -1 - boom_power; q < 2 + boom_power; q++) {
                for (w = -1 - boom_power; w < 2 + boom_power; w++) {
                    if (boom_x + q > -1 && boom_y + w > -1 && boom_x + q < map.length && boom_y + w < map[boom_x].length) {
                        if (map[boom_x + q][boom_y + w] == "人") {
                            var over = true;
                        } else if (map[boom_x + q][boom_y + w] == "怪") {
                            booming = true;
                            setTimeout("mobrestart()", 3000);
                        }
                        map[boom_x + q][boom_y + w] = "炸";
                    }
                }
            }
            boom_x = -1; //清除炸弹
            boom_y = -1;
            if (over) {
                gameover(1);
            }
            drawmap();
            setTimeout("replace()", 1000); //过一秒后清除特效，替换为“土”
        }

        // 清除特效，替换为“土”
        function replace() {
            for (e = -1 - boom_power; e < 2 + boom_power; e++) {
                for (r = -1 - boom_power; r < 2 + boom_power; r++) {
                    if (boom_x_old + e > -1 && boom_y_old + r > -1 && boom_x_old + e < map.length && boom_y_old + r < map[boom_x_old].length) {
                        map[boom_x_old + e][boom_y_old + r] = "土";
                    }
                }
            }
            drawmap();
            document.getElementById("boom").disabled = false;
        }

        // 河水蔓延
        function findwarter() {
            if (waterrun.checked) { //如果开启河水蔓延
                for (o = 0; o < map.length; o++) { //遍历全图，寻找“土”
                    for (u = 0; u < map[o].length; u++) {
                        if (map[o][u] == "土") {
                            for (q = -1; q < 2; q++) { //找到“土”，在土周围3x3区域寻找“水”
                                for (w = -1; w < 2; w++) {
                                    if (o + q > -1 && u + w > -1 && o + q < map.length && u + w < map[o].length) {
                                        if (map[o + q][u + w] == "水") { //如果周围有水
                                            map[o][u] = "水_new"; //“土”替换为“水_new”（“水_new”是新生成的水源，绘图时会被刷新为普通水源）
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                drawmap_base();

            }
            setTimeout("findwarter()", 1000); //间隔一秒重复执行
        }

        function gameover(reason) { //0：碰到mob 1：被炸死
            if (!unmatched.checked) {
                if (reason == 0) {
                    map[x][y] = '<span style="color: red;">怪</span>';
                }


                //画地图
                document.getElementById("map").innerHTML = "";
                for (i = 0; i < map.length; i++) {
                    var line = "";
                    for (j = 0; j < map[i].length; j++) {
                        if (map[i][j] != "水_new") {
                            line += map[i][j];
                        } else { //新生成的水变成普通的水，"水_new"是为了防止水蔓延的时候一次刷新多格（新手保护？）
                            line += "水";
                            map[i][j] = "水";
                        }
                    }
                    document.getElementById("map").innerHTML += line + "<br>";

                }

                //地图着色
                for (i = 0; i < word.length; i++) {
                    var oBox = document.getElementById("map");
                    var oContent = oBox.innerHTML;
                    var val = word[i];
                    var findText = oContent.split(val);
                    oBox.innerHTML = findText.join('<span style="color:' + color[i] + ';">' + val + '</span>');
                }

                alert("游戏结束！");
                location.reload();
            }
        }
    </script>

</body>

</html>